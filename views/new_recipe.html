<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add New Recipe</title>
  <script>
    let ingredientsChecked = false;

    function addIngredientField() {
      const container = document.getElementById('ingredients');
      const div = document.createElement('div');
      div.className = 'flex gap-2 mb-2';
      div.innerHTML = `
        <input type="text" name="ingredient" placeholder="Ingredient" class="w-full p-2 border rounded" />
        <input type="text" name="amount" placeholder="Amount" class="w-1/3 p-2 border rounded" />
      `;
      container.appendChild(div);
      disableSubmit();
    }

    function checkIngredients() {
      const ingredientEls = document.querySelectorAll('input[name="ingredient"]');
      const amountEls = document.querySelectorAll('input[name="amount"]');
      const ingredients = [];
      let valid = true;
      for (let i = 0; i < ingredientEls.length; i++) {
        const name = ingredientEls[i].value.trim();
        const amount = amountEls[i].value.trim();
        if (!name || !amount) {
          valid = false;
          break;
        }
        ingredients.push({ name, amount });
      }

      if (!valid) {
        ingredientsChecked = false;
        document.getElementById('submit-btn').disabled = true;
        return;
      }

      const body = JSON.stringify({ ingredients });
      fetch('/check-ingredients', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body
      }).then(response => response.json())
        .then(data => {
          if (Array.isArray(data)) {
            for (let i = 0; i < data.length && i < ingredientEls.length; i++) {
              ingredientEls[i].value = data[i].name;
            }
            ingredientsChecked = true;
            document.getElementById('submit-btn').disabled = false;
          } else {
            ingredientsChecked = false;
            document.getElementById('submit-btn').disabled = true;
          }
        }).catch(() => {
          ingredientsChecked = false;
          document.getElementById('submit-btn').disabled = true;
        });
    }

    function disableSubmit() {
      ingredientsChecked = false;
      document.getElementById('submit-btn').disabled = true;
    }

    function handleSubmit(e) {
      e.preventDefault();
      if (!ingredientsChecked) return;
      const ingredientEls = document.querySelectorAll('input[name="ingredient"]');
      const amountEls = document.querySelectorAll('input[name="amount"]');
      const ingredients = [];
      for (let i = 0; i < ingredientEls.length; i++) {
        if (ingredientEls[i].value.trim()) {
          ingredients.push({
            name: ingredientEls[i].value.trim(),
            amount: amountEls[i].value.trim()
          });
        }
      }
      const body = JSON.stringify({ ingredients });
      fetch('', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body
      });
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-xl mx-auto bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold mb-4">Add New Recipe</h1>
    <form onsubmit="handleSubmit(event)">
      <div id="ingredients">
        <div class="flex gap-2 mb-2">
          <input type="text" name="ingredient" placeholder="Ingredient" class="w-full p-2 border rounded" oninput="disableSubmit()" />
          <input type="text" name="amount" placeholder="Amount" class="w-1/3 p-2 border rounded" oninput="disableSubmit()" />
        </div>
      </div>
      <button type="button" onclick="addIngredientField()" class="mb-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
        + Add Ingredient
      </button>
      <button type="button" onclick="checkIngredients()" class="mb-4 px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">
        Check Ingredients
      </button>
      <div>
        <button id="submit-btn" type="submit" class="px-6 py-2 bg-green-500 text-white rounded hover:bg-green-600" disabled>
          Submit Recipe
        </button>
      </div>
    </form>
  </div>
</body>
</html>
